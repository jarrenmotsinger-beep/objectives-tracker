<script type="module">
    // Your Firebase configuration - replace with your own
    const firebaseConfig = {
        apiKey: "AIzaSyBTFuNqxrFLPE6TIRPXhwryKq3eRSt7PEY",
  authDomain: "daily-objectives-8922e.firebaseapp.com",
  databaseURL: "https://daily-objectives-8922e-default-rtdb.firebaseio.com",
  projectId: "daily-objectives-8922e",
  storageBucket: "daily-objectives-8922e.firebasestorage.app",
  messagingSenderId: "450105668325",
  appId: "1:450105668325:web:e64427c9316403195fda0c",
  measurementId: "G-9EKLEJJN73"
    };

    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
    import { getDatabase, ref, push, onValue, update, set, get } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // DOM Elements
    const taskForm = document.getElementById('task-form');
    const taskInput = document.getElementById('task-input');
    const assignSelect = document.getElementById('assign-select');
    const tasksList = document.getElementById('tasks');
    const usersList = document.getElementById('users-list');
    const startBtn = document.getElementById('start-btn');
    const userName = document.getElementById('user-name');
    const authMessage = document.getElementById('auth-message');
    const taskSection = document.getElementById('task-section');
    const authSection = document.getElementById('auth-section');
    const usersSection = document.getElementById('users-section');
    const welcomeUser = document.getElementById('welcome-user');

    let users = []; // Store users locally
    let currentUserName = '';
    let currentUserUid = '';

    // Start anonymous session with existing user check
    startBtn.addEventListener('click', async () => {
        try {
            const name = userName.value.trim();
            if (!name) {
                authMessage.textContent = 'Please enter a name.';
                return;
            }

            // Sign in anonymously
            const result = await signInAnonymously(auth);
            const newUid = result.user.uid;

            // Check if the name already exists
            const usersRef = ref(database, 'users');
            const snapshot = await get(usersRef);
            let existingUser = null;
            if (snapshot.exists()) {
                existingUser = Object.values(snapshot.val()).find(user => user.name.toLowerCase() === name.toLowerCase());
            }

            if (existingUser) {
                // Update existing user's UID if it differs
                if (existingUser.uid !== newUid) {
                    const userKey = Object.keys(snapshot.val()).find(key => snapshot.val()[key].name.toLowerCase() === name.toLowerCase());
                    await update(ref(database, `users/${userKey}`), { uid: newUid });
                }
                currentUserUid = newUid;
            } else {
                // New user, add to database
                await set(ref(database, `users/${newUid}`), {
                    name: name,
                    uid: newUid
                });
                currentUserUid = newUid;
            }

            currentUserName = name;
            authSection.style.display = 'none';
            taskSection.style.display = 'block';
            usersSection.style.display = 'block';
            welcomeUser.textContent = `Welcome, ${name}!`;
            await loadUsers(); // Force immediate user load
            loadTasks();
            authMessage.textContent = '';
        } catch (error) {
            authMessage.textContent = error.message;
        }
    });

    // Load users and populate dropdown
    async function loadUsers() {
        const usersRef = ref(database, 'users');
        const snapshot = await get(usersRef); // Initial fetch
        users = [];
        usersList.innerHTML = '<ul></ul>';
        const ul = usersList.querySelector('ul');
        assignSelect.innerHTML = '<option value="">Assign to...</option>';
        if (snapshot.exists()) {
            snapshot.forEach((childSnapshot) => {
                const userData = childSnapshot.val();
                users.push(userData);
                const li = document.createElement('li');
                li.textContent = userData.name;
                ul.appendChild(li);
                const option = document.createElement('option');
                option.value = userData.uid;
                option.textContent = userData.name;
                assignSelect.appendChild(option);
            });
        }
        // Keep the real-time listener for updates
        onValue(usersRef, (snap) => {
            users = [];
            usersList.innerHTML = '<ul></ul>';
            const ul = usersList.querySelector('ul');
            assignSelect.innerHTML = '<option value="">Assign to...</option>';
            snap.forEach((childSnapshot) => {
                const userData = childSnapshot.val();
                users.push(userData);
                const li = document.createElement('li');
                li.textContent = userData.name;
                ul.appendChild(li);
                const option = document.createElement('option');
                option.value = userData.uid;
                option.textContent = userData.name;
                assignSelect.appendChild(option);
            });
        });
    }

    // Add task with assignment
    taskForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const taskText = taskInput.value.trim();
        const assignedUid = assignSelect.value;
        if (taskText && auth.currentUser) {
            const taskData = {
                text: taskText,
                status: 'pending',
                createdBy: currentUserName,
                userId: currentUserUid
            };
            if (assignedUid) {
                const assignedUser = users.find(u => u.uid === assignedUid);
                taskData.assignedToUid = assignedUid;
                taskData.assignedToName = assignedUser.name;
            }
            push(ref(database, 'tasks'), taskData);
            taskInput.value = '';
            assignSelect.value = '';
        }
    });

    // Load and render tasks with buttons
    function loadTasks() {
        const tasksRef = ref(database, 'tasks');
        onValue(tasksRef, (snapshot) => {
            tasksList.innerHTML = '';
            snapshot.forEach((childSnapshot) => {
                const task = childSnapshot.val();
                const taskKey = childSnapshot.key;
                const li = document.createElement('li');
                let displayText = `${task.text}`;
                if (task.assignedToName) displayText += ` (Assigned to: ${task.assignedToName})`;
                displayText += ` (Created by: ${task.createdBy})`;
                li.textContent = displayText;
                if (task.status === 'completed') li.classList.add('completed');

                const statusDiv = document.createElement('div');
                ['pending', 'in-progress', 'completed'].forEach(status => {
                    const btn = document.createElement('button');
                    btn.className = 'status-btn';
                    btn.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    if (task.status === status) btn.classList.add('active');
                    btn.addEventListener('click', () => {
                        const updates = { status: status, userId: currentUserUid };
                        if (status === 'completed') {
                            updates.lastCompletedBy = currentUserName;
                        }
                        update(ref(database, 'tasks/' + taskKey), updates);
                    });
                    statusDiv.appendChild(btn);
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => {
                    remove(ref(database, 'tasks/' + taskKey));
                });

                li.appendChild(statusDiv);
                li.appendChild(deleteBtn);
                tasksList.appendChild(li);
            });
        });
    }

    // Authentication state listener (for initial state or re-auth)
    onAuthStateChanged(auth, (user) => {
        if (user && user.isAnonymous) {
            authSection.style.display = 'none';
            taskSection.style.display = 'block';
            usersSection.style.display = 'block';
            const userData = users.find(u => u.uid === user.uid);
            currentUserName = userData ? userData.name : '';
            currentUserUid = user.uid;
            if (currentUserName) {
                welcomeUser.textContent = `Welcome, ${currentUserName}!`;
                loadUsers();
                loadTasks();
            }
        } else {
            authSection.style.display = 'block';
            taskSection.style.display = 'none';
            usersSection.style.display = 'none';
            welcomeUser.textContent = '';
            tasksList.innerHTML = '';
            usersList.innerHTML = '';
            userName.value = '';
            authMessage.textContent = '';
        }
    });
</script>
