// app.js

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyBTFuNqxrFLPE6TIRPXhwryKq3eRSt7PEY",
    authDomain: "daily-objectives-8922e.firebaseapp.com",
    databaseURL: "https://daily-objectives-8922e-default-rtdb.firebaseio.com",
    projectId: "daily-objectives-8922e",
    storageBucket: "daily-objectives-8922e.firebasestorage.app",
    messagingSenderId: "450105668325",
    appId: "1:450105668325:web:e64427c9316403195fda0c",
    measurementId: "G-9EKLEJJN73"
};

// Import Firebase modules
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
import { getDatabase, ref, push, onValue, update, remove, set } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Database references
const tasksRef = ref(db, 'tasks');
const usersRef = ref(db, 'users');

// DOM Elements
const taskForm = document.getElementById('task-form');
const taskInput = document.getElementById('task-input');
const addressInput = document.getElementById('address-input');
const assigneeSelect = document.getElementById('assignee-select');
const tasksList = document.getElementById('tasks');
const loginBtn = document.getElementById('login-btn');
const signupBtn = document.getElementById('signup-btn');
const logoutBtn = document.getElementById('logout-btn');
const userName = document.getElementById('user-name');
const userEmail = document.getElementById('user-email');
const userPassword = document.getElementById('user-password');
const authMessage = document.getElementById('auth-message');
const taskSection = document.getElementById('task-section');
const authSection = document.getElementById('auth-section');
const usersSection = document.getElementById('users-section');
const userList = document.getElementById('user-list');

// Authentication state listener
onAuthStateChanged(auth, (user) => {
    if (user) {
        authSection.style.display = 'none';
        taskSection.style.display = 'block';
        logoutBtn.style.display = 'inline-block';
        usersSection.style.display = 'block';
        loadUsers();
        loadTasks();
        loadAssignees();
    } else {
        authSection.style.display = 'block';
        taskSection.style.display = 'none';
        logoutBtn.style.display = 'none';
        usersSection.style.display = 'none';
        tasksList.innerHTML = '';
        userList.innerHTML = '';
        authMessage.textContent = '';
    }
});

// Sign up
signupBtn.addEventListener('click', async () => {
    try {
        const { user } = await createUserWithEmailAndPassword(auth, userEmail.value, userPassword.value);
        await set(ref(db, `users/${user.uid}`), { name: userName.value, email: userEmail.value });
        authMessage.textContent = 'Signed up successfully!';
        userName.value = '';
        userEmail.value = '';
        userPassword.value = '';
    } catch (error) {
        authMessage.textContent = error.message;
    }
});

// Login
loginBtn.addEventListener('click', async () => {
    try {
        await signInWithEmailAndPassword(auth, userEmail.value, userPassword.value);
        authMessage.textContent = 'Logged in successfully!';
    } catch (error) {
        authMessage.textContent = error.message;
    }
});

// Logout
logoutBtn.addEventListener('click', async () => {
    try {
        await signOut(auth);
        authMessage.textContent = 'Logged out.';
    } catch (error) {
        authMessage.textContent = error.message;
    }
});

// Add task with address
taskForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const taskText = taskInput.value.trim();
    const addressText = addressInput.value.trim();
    const assigneeUid = assigneeSelect.value;
    if (taskText && addressText) {
        push(tasksRef, {
            text: taskText,
            address: addressText, // Add address to the database entry
            status: 'pending',
            assigneeUid: assigneeUid || null,
            assignedBy: auth.currentUser.uid,
            timestamp: Date.now()
        });
        taskInput.value = '';
        addressInput.value = '';
        assigneeSelect.value = '';
    }
});

// Load users for display
function loadUsers() {
    onValue(usersRef, (snapshot) => {
        userList.innerHTML = '';
        snapshot.forEach((childSnapshot) => {
            const userData = childSnapshot.val();
            const userSpan = document.createElement('span');
            userSpan.classList.add('user-item');
            userSpan.textContent = userData.name || userData.email;
            userList.appendChild(userSpan);
        });
    });
}

// Load assignees for dropdown
function loadAssignees() {
    onValue(usersRef, (snapshot) => {
        assigneeSelect.innerHTML = '<option value="">Select Assignee</option>';
        snapshot.forEach((childSnapshot) => {
            const userData = childSnapshot.val();
            const option = document.createElement('option');
            option.value = childSnapshot.key;
            option.textContent = userData.name || userData.email;
            assigneeSelect.appendChild(option);
        });
    });
}

// Load and render tasks as itinerary stops
function loadTasks() {
    onValue(tasksRef, (snapshot) => {
        tasksList.innerHTML = '';
        snapshot.forEach((childSnapshot) => {
            const task = childSnapshot.val();
            const taskKey = childSnapshot.key;
            const li = document.createElement('li');

            const taskHeader = document.createElement('div');
            taskHeader.classList.add('task-header');

            const taskDetails = document.createElement('div');
            taskDetails.classList.add('task-details');

            const objectiveSpan = document.createElement('span');
            objectiveSpan.textContent = task.text;
            objectiveSpan.style.fontWeight = 'bold';
            objectiveSpan.style.color = '#333';

            const addressSpan = document.createElement('span');
            addressSpan.classList.add('address-info');
            addressSpan.textContent = task.address;

            // Create Google Maps link
            const mapLink = document.createElement('a');
            mapLink.href = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(task.address)}`;
            mapLink.target = '_blank';
            mapLink.classList.add('map-link');
            mapLink.textContent = 'Get Directions';

            const assigneeSpan = document.createElement('span');
            assigneeSpan.classList.add('assignee-info');

            // Fetch and display assignee name
            if (task.assigneeUid) {
                const assigneeRef = ref(db, `users/${task.assigneeUid}`);
                onValue(assigneeRef, (userSnap) => {
                    if (userSnap.exists()) {
                        const userData = userSnap.val();
                        assigneeSpan.textContent = `Assigned to: ${userData.name || userData.email}`;
                    }
                }, { onlyOnce: true });
            }

            taskDetails.appendChild(objectiveSpan);
            taskDetails.appendChild(addressSpan);
            taskDetails.appendChild(mapLink);
            taskDetails.appendChild(assigneeSpan);

            const taskActions = document.createElement('div');
            taskActions.classList.add('task-actions');

            const completeBtn = document.createElement('button');
            completeBtn.textContent = 'Complete';
            completeBtn.classList.add('complete-btn');
            completeBtn.addEventListener('click', () => {
                // You can add logic here to move to an 'archived' list
                remove(ref(db, 'tasks/' + taskKey));
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.classList.add('delete-btn');
            deleteBtn.addEventListener('click', () => {
                remove(ref(db, 'tasks/' + taskKey));
            });

            taskActions.appendChild(completeBtn);
            taskActions.appendChild(deleteBtn);

            li.appendChild(taskDetails);
            li.appendChild(taskActions);
            tasksList.appendChild(li);
        });
    });
}
